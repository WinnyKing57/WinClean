name: Build Debian Package

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  build-deb:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install build dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y debhelper build-essential fakeroot
        
    - name: Clean previous builds
      run: |
        cd debian-storage-analyzer
        # Nettoyer complÃ¨tement les anciens builds
        echo "ğŸ§¹ Nettoyage des anciens builds..."
        debian/rules clean || true
        
        # Supprimer tous les fichiers/dossiers de build temporaires
        rm -rf debian/debian-storage-analyzer
        rm -rf debian/.debhelper
        rm -rf debian/tmp
        rm -f debian/files
        rm -f debian/debhelper-build-stamp
        rm -f debian/*.substvars
        rm -f debian/*.log
        rm -f debian/*.debhelper
        
        # Nettoyer aussi les fichiers dans le rÃ©pertoire parent
        cd ..
        rm -f debian-storage-analyzer_*.deb
        rm -f debian-storage-analyzer_*.changes
        rm -f debian-storage-analyzer_*.buildinfo
        rm -f debian-storage-analyzer_*.tar.xz
        rm -f debian-storage-analyzer_*.dsc
        
        echo "âœ… Nettoyage terminÃ©"
        
    - name: Verify clean state
      run: |
        cd debian-storage-analyzer
        echo "ğŸ” VÃ©rification de l'Ã©tat propre..."
        
        # VÃ©rifier qu'aucun fichier de build temporaire n'existe
        if [ -d "debian/debian-storage-analyzer" ]; then
          echo "âŒ ERREUR: debian/debian-storage-analyzer existe encore"
          exit 1
        fi
        
        if [ -d "debian/.debhelper" ]; then
          echo "âŒ ERREUR: debian/.debhelper existe encore"
          exit 1
        fi
        
        if [ -f "debian/files" ]; then
          echo "âŒ ERREUR: debian/files existe encore"
          exit 1
        fi
        
        echo "âœ… Ã‰tat propre vÃ©rifiÃ©"
        
    - name: Build Debian package
      run: |
        cd debian-storage-analyzer
        dpkg-buildpackage -us -uc -b
        
    - name: Prepare artifacts
      run: |
        mkdir -p dist
        mv *.deb dist/ || true
        mv *.changes dist/ || true
        mv *.buildinfo dist/ || true
        
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: debian-packages
        path: dist/
        
    - name: List built packages
      run: |
        echo "ğŸ“¦ Packages built:"
        ls -la dist/